<!DOCTYPE html>
<html lang="de">

<head>
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ff8c00">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punkte-Rechner</title>
    <style>
        :root {
            --bg-color: #f4f4f9;
            --container-bg: #ffffff;
            --text-color: #333333;
            --input-border: #cccccc;
            --result-bg: #fff5e6;
            --accent-color: #ff8c00;
            --focus-color: #ff4d01;
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #f4f4f4;
            --input-border: #444444;
            --result-bg: #2d1f10;
            --accent-color: #ffa500;
            --focus-color: #ff4d01;
        }

        body {
            font-family: sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 15px 8px;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s ease;
        }

        .container {
            background: var(--container-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 99%;
            box-sizing: border-box;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .top-btns {
            display: flex;
            gap: 5px;
        }

        .small-btn {
            cursor: pointer;
            width: 42px;
            height: 42px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;

            border-radius: 8px;
            border: 1px solid var(--input-border);
            background: var(--result-bg);
            color: var(--text-color);
            font-size: 1.1em;
            outline: none;
            transition: transform 0.1s active;
        }

        .small-btn:active {
            transform: scale(0.95);
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: bold;
            font-size: 0.85em;
        }

        /* Input Styling */
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
            background: var(--container-bg);
            color: var(--text-color);
            outline: none;
            transition: border 0.2s;
        }

        /* Fokus-Effekt (Orange statt Blau) */
        .input-group input:focus {
            border: 2px solid var(--accent-color);
            background-color: var(--result-bg);
        }

        /* Entfernen der Hoch/Runter Pfeile */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }

        .portion-group input {
            border: 2px solid var(--accent-color);
            font-weight: bold;
        }

        .result-area {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--result-bg);
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--accent-color);
        }

        .res-big {
            font-size: 2.2em;
            font-weight: bold;
            color: var(--accent-color);
            display: block;
        }

        .res-small {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--text-color);
            display: block;
            margin-top: 10px;
        }

        .unit {
            font-size: 0.5em;
            font-weight: normal;
            margin-left: 5px;
            color: var(--text-color);
        }

        .btn-save {
            width: 100%;
            margin-top: 15px;
            padding: 12px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }

        button:focus {
            outline: none;
            /*border: 1px solid var(--focus-color);*/
        }

        /*
        .btn-save:focus {
            box-shadow: 0 0 8px var(--accent-color);
        }
*/
        .list-container {
            margin-top: 25px;
            width: 100%;
            max-width: 400px;
        }

        .fav-item {
            background: var(--container-bg);
            margin-bottom: 8px;
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .delete-btn {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="header">
            <h2>Punkterechner</h2>
            <div class="top-btns">
                    <div style="display: flex; gap: 5px; margin-right: 15px;">
                        <button class="small-btn" onclick="exportNotes()" title="Export">ðŸ“¤</button>
                        <button class="small-btn" onclick="importNotes()" title="Import">ðŸ“¥</button>
                    </div>

                    <div style="display: flex; gap: 5px;">
                        <button class="small-btn" onclick="toggleTheme()" title="Theme">ðŸŒ“</button>
                    </div>
                </div>
            </div>

        <div class="input-group">
            <label>Name:</label>
            <input type="text" id="name" placeholder="z.B. KÃ¤sebrot" enterkeyhint="next"
                onkeydown="tabOnEnter(event, 'kcal')">
        </div>

        <div class="input-group">
            <label>Kalorien (kcal):</label>
            <input type="number" id="kcal" value="0" oninput="berechnen()" onclick="this.select()" enterkeyhint="next"
                onkeydown="tabOnEnter(event, 'fett')">
        </div>

        <div class="input-group">
            <label>Fett (g):</label>
            <input type="number" id="fett" value="0" oninput="berechnen()" onclick="this.select()" enterkeyhint="next"
                onkeydown="tabOnEnter(event, 'gramm')">
        </div>

        <div class="input-group portion-group">
            <label>PortionsgrÃ¶ÃŸe (g):</label>
            <input type="number" id="gramm" value="100" oninput="berechnen()" onclick="this.select()"
                enterkeyhint="done" onkeydown="tabOnEnter(event, 'done')">
        </div>

        <div class="result-area">
            <span id="resPortion" class="res-big">1,4 <span class="unit">Punkte / Portion</span></span>
            <span id="res100" class="res-small">0,94 <span class="unit">Punkte / 100g</span></span>
        </div>

        <button class="btn-save" onclick="saveFavorite()">Als Favorit speichern</button>
    </div>

    <div class="list-container" id="favList"></div>

    <script>
        // Theme & Initialisierung
        function setTheme(t) { localStorage.setItem('theme', t); document.documentElement.setAttribute('data-theme', t); }
        function toggleTheme() { localStorage.getItem('theme') === 'dark' ? setTheme('light') : setTheme('dark'); }
        if (localStorage.getItem('theme') === 'dark') setTheme('dark');

        // Reset beim Laden der Seite (behebt das Firefox-Problem)
        window.onload = function () {
            document.getElementById('name').value = '';
            document.getElementById('kcal').value = '0';
            document.getElementById('fett').value = '0';
            document.getElementById('gramm').value = '100';
            berechnen();
            renderFavs();
        };

        function berechnen() {
            const kcal = parseFloat(document.getElementById('kcal').value) || 0;
            const fett = parseFloat(document.getElementById('fett').value) || 0;
            const gramm = parseFloat(document.getElementById('gramm').value) || 0;
            const p100 = (kcal / 60) + (fett / 9);
            const pPortion = (p100 * gramm) / 100;
            document.getElementById('res100').innerHTML = p100.toFixed(2).replace('.', ',') + ' <span class="unit">Punkte / 100g</span>';
            document.getElementById('resPortion').innerHTML = pPortion.toFixed(1).replace('.', ',') + ' <span class="unit">Punkte / Portion</span>';
        }

        // ENTER: Springe zum nÃ¤chsten Feld
        function tabOnEnter(event, nextId) {
            if (event.key === "Enter") {
                event.preventDefault(); // Verhindert Standard-Aktion

                if (nextId === 'done') {
                    // Tastatur schlieÃŸen, indem der Fokus vom aktuellen Element entfernt wird
                    document.activeElement.blur();
                } else {
                    // Zum nÃ¤chsten Feld springen
                    const nextElement = document.getElementById(nextId);
                    if (nextElement) {
                        nextElement.focus();
                        // Falls es ein Input ist, direkt den Text markieren
                        if (nextElement.tagName === 'INPUT' && nextElement.type !== 'text') {
                            nextElement.select();
                        }
                    }
                }
            }
        }

        // Favoriten

        // PrÃ¼ffunktion fÃ¼r Duplikate (Name + Werte)
        function isDuplicate(newFav, existingFavs) {
            return existingFavs.some(f =>
                f.name.toLowerCase() === newFav.name.toLowerCase() &&
                f.pPortion === newFav.pPortion &&
                f.p100 === newFav.p100
            );
        }

        function saveFavorite() {
            const name = document.getElementById('name').value || "Unbenannt";
            const pPortion = document.getElementById('resPortion').innerText.split(' ')[0];
            const p100 = document.getElementById('res100').innerText.split(' ')[0];

            const newFav = { id: Date.now(), name, pPortion, p100 };
            let favs = JSON.parse(localStorage.getItem('favs')) || [];

            if (isDuplicate(newFav, favs)) {
                alert("Dieser Eintrag existiert bereits mit den gleichen Werten.");
                return;
            }

            favs.push(newFav);
            localStorage.setItem('favs', JSON.stringify(favs));
            renderFavs();
            document.getElementById('name').value = '';
        }

        function deleteFav(id) {
            let favs = JSON.parse(localStorage.getItem('favs')).filter(f => f.id !== id);
            localStorage.setItem('favs', JSON.stringify(favs));
            renderFavs();
        }

        function renderFavs() {
            const list = document.getElementById('favList');
            const favs = JSON.parse(localStorage.getItem('favs')) || [];
            list.innerHTML = favs.length > 0 ? '<h3>Deine Favoriten</h3>' : '';
            favs.forEach(f => {
                list.innerHTML += `<div class="fav-item"><div><strong>${f.name}</strong><br><small>${f.pPortion} Pkt. (${f.p100} / 100g)</small></div>
            <button class="delete-btn" onclick="deleteFav(${f.id})">LÃ¶schen</button></div>`;
            });
        }

        // Export / Import
        function exportFavs() {
            const data = localStorage.getItem('favs');
            if (!data || data === "[]") return alert("Keine Favoriten vorhanden.");
            const blob = new Blob([data], { type: "application/json" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "punkterechner_favoriten.json";
            a.click();
        }

        // Import mit Duplikat-Check
        function importFavs() {
            const input = document.createElement("input");
            input.type = "file";
            input.accept = ".json";
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        let currentFavs = JSON.parse(localStorage.getItem('favs')) || [];
                        let addedCount = 0;

                        importedData.forEach(newFav => {
                            if (!isDuplicate(newFav, currentFavs)) {
                                // Neue ID vergeben, um Konflikte zu vermeiden
                                newFav.id = Date.now() + Math.random();
                                currentFavs.push(newFav);
                                addedCount++;
                            }
                        });

                        localStorage.setItem('favs', JSON.stringify(currentFavs));
                        renderFavs();
                        alert(addedCount + " neue Favoriten importiert.");
                    } catch (err) {
                        alert("Fehler beim Importieren der Datei.");
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        renderFavs();
        berechnen();

        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }
        
        // TODO, bei fav speicherung gespeicherte portionsmenge noch mit speichern
    </script>
</body>

</html>
